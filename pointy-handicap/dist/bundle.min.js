!function(){"use strict";const t=console;class e{constructor(t,e,s){this._app=t,this._props=e,this._key=s,this._vCache={},this._matchers={},this._vals={},this.v=this._view.bind(this)}draw(){this._draw(r,this.v,this._app,this._props,this._key,this)}wrap(t){return this.root=t,this.el=t.el,t}match(t,e){this._matchers.hasOwnProperty(t)||(this._matchers[t]=[]),this._matchers[t].push(e)}update(t){this._update(r,this.v,this._app,t,this._key,this)}_update(t,e,s,r,n,a){for(let t in a._matchers){let e=r[t];a._vals[t]!==e&&a._matchers[t].forEach(t=>{t(e,r)}),a._vals[t]=e}}_view(t,e,s){let r;if(null==s)(r=new t(this._app,e)).draw();else{let n=t.name;this._vCache.hasOwnProperty(n)||(this._vCache[n]={});let a=this._vCache[n];a.hasOwnProperty(s)?r=a[s]:((r=new t(this._app,e,s)).draw(),a[s]=r)}return r.update(e),r}}class s extends e{_draw(t,e,s,r,n,a){a.wrap(a.overlay(t,e,s,r,n,a).on("click",t=>{t.target==a.el&&a.reject("user-cancelled")})),a.promise=new Promise((t,e)=>{a.resolve=t,a.reject=e}),a.root.inner(a.content(t,e,s,r,n,a))}}function r(t){return new n(t)}class n{constructor(t){t.startsWith("#")?this.el=document.getElementById(t.substr(1)):this.el=document.createElement(t)}atts(t){for(let e in t)this.el.setAttribute(e,t[e]);return this}checked(t){return this.el.checked=t,this}class(t){return this.el.className=t,this}clear(){return this.el.innerHTML="",this}on(t,e){return this.el.addEventListener(t,e),this}id(t){return this.el.id=t,this}inner(t){this.el.innerHTML="",Array.isArray(t)||(t=[t]);let s=document.createDocumentFragment();return t.forEach(t=>{t instanceof n||t instanceof e?s.appendChild(t.el):t instanceof Node?s.appendChild(t):s.appendChild(document.createTextNode(t.toString()))}),this.el.appendChild(s),this}html(t){return this.el.innerHTML=t,this}text(t){return this.el.textContent=t,this}}class a extends e{constructor(t,e){super(t),this.wrap(r("#"+e))}goto(t){this.root.inner(this._view(t.cls,t.props,t.keyFn(t.props)))}}class i{constructor(t,e,s){let r;this.cls=e,this.keyFn=s||function(){return 1},[t,r]=t.split("?"),this.pattern=t,this.chunks=t.split("/").map(t=>t.startsWith("{")?new o(t.slice(1,-1)):t),this.params={},r&&r.split(",").forEach(t=>{let e=new o(t.trim());this.params[e.name]=e})}matches(t){let e,s,r;[e,s]=t.split("?"),r=e.split("/");let n,a,i={},h=0,l=this.chunks.length,c=!1;if(l==r.length){for(;;){if(n=this.chunks[h],a=r[h],n instanceof o)i[n.name]=n.convert(a);else if(n!==a){c=!0;break}if(++h>l)break}if(!c)return s&&s.split("&").forEach(t=>{let e,s;[e,s]=t.split("="),this.params.hasOwnProperty(e)&&(i[e]=this.params[e].convert(s))}),this.props=i,!0}return!1}}class o{constructor(t){let e,s;switch([e,s]=t.split(":"),this.name=e,s){case"int":this.conv=(t=>parseInt(t));break;case"float":this.conv=(t=>parseFloat(t));break;default:this.conv=(t=>t)}}convert(t){return this.conv(t)}}const h=console;class l{constructor(t={keyPath:"id",autoIncrement:!0}){this.defaultConf=t,this._versions=[]}addVersion(t){this._versions.push(t)}getVersion(){return this._versions.length+1}upgrade(t,e){let s=new u(this,t,this.defaultConf);this._versions.forEach((t,r)=>{r>=e&&t(s,!0)})}createFunctions(t){let e=new c(this,t);this._versions.forEach((t,s)=>{t(e,!1)})}getFkName(t){return`__${t}Id`}getLinkStoreName(t,e){return`m2m__${t}__${e}`}}class c{constructor(t,e){this.schema=t,this.target=e}capitalize(t){return t.charAt(0).toUpperCase()+t.slice(1)}addStore(t){let e=this.capitalize(t),s=e+"s";this.target["put"+e]=function(e){return this.put(t,e)},this.target["del"+e]=function(e){return this.del(t,e)},this.target["get"+e]=function(e){return this.get(t,e)},this.target["getAll"+s]=function(e){return this.getAll(t,e)}}oneToMany(t,e){let s=this.capitalize(t),r=this.capitalize(e),n=r+"s";this.target["get"+r+s]=function(s){return this.getParent(e,t,s)},this.target["get"+s+n]=function(s){return this.getChildren(t,e,s)},this.target["set"+r+s]=function(s,r){return this.setParent(e,t,s,r)}}manyToMany(t,e){this.target;let s=this.schema.getLinkStoreName(t,e),r=this.capitalize(t),n=this.capitalize(e),a=r+"s",i=n+"s";this.target["get"+r+i]=function(t){return this.getChildren(e,s,t)},this.target["get"+n+a]=function(t){},this.target["link"+r+n]=function(s,r){return this.link(t,e,s,r)},this.target["link"+n+r]=function(s,r){return this.link(t,e,r,s)},this.target["unlink"+r+n]=function(t,e){},this.target["unlink"+n+r]=function(t,e){}}}class u{constructor(t,e,s){this.schema=t,this.idb=e,this.stores={},this.defaultConf=s}addStore(t,e=this.defaultConf){let s=this.idb.createObjectStore(t,e);return this.stores[t]=s,s}oneToMany(t,e){h.log(t),h.log(e),h.log(this.schema.getFkName(t)),this.stores[e].createIndex(t,this.schema.getFkName(t))}manyToMany(t,e){let s=this.idb.createObjectStore(this.schema.getLinkStoreName(t,e),this.defaultConf);s.createIndex(t,this.schema.getFkName(t)),s.createIndex(e,this.schema.getFkName(e))}}const d=new l;var p;p="pointy-v2",indexedDB.deleteDatabase(p),d.addVersion((t,e)=>{let s=t.addStore("target");t.addStore("record"),t.addStore("category");e&&(s.put({due:new Date,text:"20 pushups",value:50}),s.put({due:new Date,text:"call mum",value:70}),s.put({due:new Date,text:"20 pushups",value:50}),s.put({due:new Date,text:"clean house",value:50}),s.put({due:new Date,text:"check car",value:50}),s.put({due:new Date,text:"20 pushups",value:50}),s.put({due:new Date,text:"call mum",value:70}),s.put({due:new Date,text:"20 pushups",value:50}),s.put({due:new Date,text:"clean house",value:50}),s.put({due:new Date,text:"check car",value:50}),s.put({due:new Date,text:"20 pushups",value:50}))});const g=new class{constructor(t,e){if(e instanceof l)this.schema=e;else{let t=new l;t.addVersion(e),this.schema=t}this._caches={},this._fullyLoaded={},this._dbp=new Promise((e,s)=>{let r=indexedDB.open(t,this.schema.getVersion());r.onerror=(()=>{console.log(r.error),s(r.error)}),r.onsuccess=(()=>{this.schema.createFunctions(this),e(r.result)}),r.onupgradeneeded=(t=>{this.schema.upgrade(r.result,t.oldVersion)})})}ready(){return this._dbp}clear(){let t=[];return this._dbp.then(e=>{let s=e.objectStoreNames,r=e.objectStoreNames.length;for(let e=0;e<r;e++){let r=s[e];t.push(this._wrap(r,"clear","readwrite").then(()=>this._caches[r]={}))}return Promise.all(t)})}dump(){let t={},e=[];return this._dbp.then(s=>{let r=s.objectStoreNames,n=s.objectStoreNames.length;for(let s=0;s<n;s++){let n=r[s];e.push(this.getAll(n).then(e=>t[n]=e))}return Promise.all(e).then(e=>t)})}_cacheOf(t){return this._caches.hasOwnProperty(t)||(this._caches[t]={}),this._caches[t]}_wrap(t,e,s,...r){return this._dbp.then(n=>new Promise((a,i)=>{let o=n.transaction(t,s),h=o.objectStore(t)[e](...r);o.oncomplete=(()=>a(h.result)),o.onabort=o.onerror=(()=>i(o.error))}))}put(t,e){return this._wrap(t,"put","readwrite",e).then(s=>(e.id=s,this._cacheOf(t)[s]=e,e))}del(t,e){return this._wrap(t,"delete","readwrite",e.id).then(s=>(delete this._cacheOf(t)[e.id],!0))}get(t,e){let s=this._cacheOf(t)[e];return null==s?this._wrap(t,"get",void 0,e).then(s=>(this._cacheOf(t)[e]=s,s)):Promise.resolve(s)}getAll(t){return this._fullyLoaded[t]?Promise.resolve(Object.values(this._cacheOf(t))):this._wrap(t,"getAll").then(e=>{let s=this._cacheOf(t);return this._fullyLoaded[t]=!0,e.map(t=>s[t.id]=t),e})}_criteriaMatch(t,e){for(let s in e)if(t[s]!==e[s])return!1;return!0}_fetchOne(t,e){return this._dbp.then(s=>new Promise((r,n)=>{let a=[],i=s.transaction(t).objectStore(t).openCursor();i.onerror=(t=>h.log(t)),i.onsuccess=(t=>{var s=t.target.result;if(s){let t=s.value;this._criteriaMatch(t,e)?a.push(t):s.continue()}else r(a)})}))}filter(t,e){return this._dbp.then(s=>new Promise((r,n)=>{let a=[],i=s.transaction(t).objectStore(t).openCursor();i.onerror=(t=>n(i.error)),i.onsuccess=(t=>{var s=t.target.result;if(s){let t=s.value;this._criteriaMatch(t,e)&&a.push(t),s.continue()}else r(a)})}))}getParent(t,e,s){let r=s[this.schema.getFkName(e)];return null==r?Promise.resolve(void 0):this.get(e,r)}_filterOnIndex(t,e,s){return this._dbp.then(r=>new Promise((n,a)=>{let i=[],o=r.transaction(t);console.log(e);let h=o.objectStore(t).index(e),l=IDBKeyRange.only(s);h.openCursor(l).onsuccess=(t=>{let e=t.target.result;if(e){let t=e.value;i.push(t),e.continue()}else n(i)})}))}getChildren(t,e,s){return this._filterOnIndex(e,t,s.id)}getLinked(t,e,s){return this._dbp.then(r=>new Promise((n,a)=>{let i=[],o=r.transaction(t).objectStore(t).index(e),h=IDBKeyRange.only(s.id);o.openCursor(h).onsuccess=(t=>{let e=t.target.result;if(e){let t=e.value;i.push(t),e.continue()}else n(i)})}))}setParent(t,e,s,r){return s[this.schema.getFkName(e)]=r.id,this.put(t,s)}link(t,e,s,r){let n=this.schema.getLinkStoreName(t,e),a={};return a[this.schema.getFkName(t)]=s.id,a[this.schema.getFkName(e)]=r.id,this.put(n,a)}}("pointy-v2",d);var m;Date.prototype.toDatetimeLocal=function(){var t=function(t){return(t<10?"0":"")+t};return this.getFullYear()+"-"+t(this.getMonth()+1)+"-"+t(this.getDate())+"T"+t(this.getHours())+":"+t(this.getMinutes())+":"+t(this.getSeconds())},Date.prototype.fromDatetimeLocal=(m="2006-06-06T06:06",new Date(m).toISOString().slice(0,16)===m?function(){return new Date(this.getTime()+6e4*this.getTimezoneOffset()).toISOString()}:Date.prototype.toISOString);class w extends s{overlay(t,e,s,r,n,a){return t("div").class("modal-background")}content(t,e,s,r,n,a){let i;if(void 0===r)i={text:"",value:50,due:new Date};else if(Array.isArray(r)){let t=r[0];i={text:t.text,value:t.value,due:t.due}}else i=r;let o=t("input").class("modal-input modal-autofocus").atts({list:"suggestions",value:i.text}).on("change",t=>{i.text=t.target.value}),h=t("input").class("modal-input").atts({type:"range",min:0,max:200,value:i.value,step:5}).on("change",t=>{i.value=t.target.value,console.log("")}),l=t("datalist").id("suggestions").inner(["a","black","bling","car"].map(e=>t("option").inner(e)));console.log(i.due.toDatetimeLocal());let c=t("input").class("modal-input").atts({type:"datetime-local",value:i.due.toDatetimeLocal()}).on("change",t=>{i.due=new Date(t.target.value),console.log(t.target.value)});return t("div").class("modal-content modal-animate").inner([t("div").inner([o,l,h,c]),t("button").text("OK").on("click",t=>a.resolve(i)),t("button").text("Cancel").on("click",t=>a.reject("user-cancelled"))])}}const f=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];class v extends e{_draw(t,e,s,r,n,a){let i=t("div").class("target-text"),o=t("div"),h=t("div").class("target-value"),l=t("div").class("target-row").on("click",t=>{s.showModal(w,r).then(t=>{s.putTarget(t)})}).inner([o,h,i]);a.wrap(l),a.match("text",t=>i.text(t)),a.match("due",e=>{let s=f[e.getDay()],r=e.getDate();o.inner([t("div").class("target-due-date").text(`${s} ${r}`),t("div").class("target-due-time").text(`${e.getHours()}:${e.getMinutes()}`)])}),a.match("value",t=>h.text(`-${t}`))}formatDate(t,e){return day+" "+date}}const _=[["/",class extends e{_draw(t,e,s,r,n,a){a.targetsScroll=t("div").class("target-scroll");let i=t("img").class("plus-btn").atts({src:"img/plus-btn.png"});a.btnAdd=t("a").inner(i).on("click",t=>{s.showModal(w).then(t=>{s.putTarget(t)})}),a.wrap(t("div").inner([a.targetsScroll,a.btnAdd])),s.on("refresh",i=>{a.drawTargets(t,a,i.targets),a.colourExpired(t,e,s,r,n,a)})}drawTargets(t,e,s){let r=(n=s,n.sort((t,e)=>(new Date(t.due),new Date(e.due),t.due<e.due?-1:t.due>e.due?1:0))).map(t=>e.v(v,t,t.id));var n;e.targetsScroll.inner(r)}colourExpired(t,e,s,r,n,a){}}],["todos/{id}?name,age",""]],y=new class{constructor(){this._eventWatchers={},this._views={}}view(t,e){let s=new t(this);s.draw(),e&&(this._views[e]=s)}emit(t,e){this._watchers(t).forEach(t=>t(e))}on(t,e){this._watchers(t).push(e)}_watchers(t){let e=this._eventWatchers[t];return null==e&&(e=[],this._eventWatchers[t]=e),e}};y.db=g,y.router=new class{constructor(t,e,s){this._app=t,this.pageContainer=new a(this._app,e),this.routes=s.map(t=>new i(...t)),window.addEventListener("hashchange",t=>this._hashChanged()),window.addEventListener("load",t=>this._hashChanged())}add(t,e,s){this.routes.push(new i(t,e,keyFn))}_hashChanged(t){let e=location.hash.slice(1)||"/",s=this._getRoute(e);if(!s)throw new Error("Route not matched: "+e);this.pageContainer.goto(s)}_goto(t){}_getRoute(t){let e=this.routes.length;for(let s=0;s<e;s++){let e=this.routes[s];if(e.matches(t))return e}}}(y,"page-container",_),y.modalContainer=new class{constructor(t,e){this._app=t,this._el=r("#"+e)}showModal(e,s){let r=new e(this._app,s);r.draw(),this._el.inner(r);let n=document.getElementsByClassName("modal-autofocus")[0];return n&&n.focus(),r.promise.then(t=>(this._el.clear(),t)).catch(e=>{throw this._el.clear(),t.log(`Modal rejected (${e}). You can ignore the next error log.`),e})}}(y,"modal-container"),y.view(class extends e{_draw(t,e,s,r,n,a){let i=t("span").html("&#9776;").class("menu-button").on("click",t=>a.showMenu()),o=t("a").atts({href:"#"}).html("&times;").class("closebtn").on("click",t=>a.hideMenu());a.menuDiv=t("div").id("menu").class("overlay").inner([o,t("div").class("overlay-content").inner([a.getMenuEntry(s,t,"Home",""),a.getMenuEntry(s,t,"Stuff","page2"),a.downloadButton(t,e,s,r,n,a)])]),a.wrap(t("#menu-container")).inner([a.menuDiv,i])}downloadButton(t,e,s,r,n,a){return t("a").atts({href:"#"}).text("Download").on("click",t=>{s.db.dump().then(t=>{!function(t,e){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}("pointydb.json",JSON.stringify(t)),this.hideMenu()})})}getMenuEntry(t,e,s,r){return e("a").atts({href:"#"+r}).text(s).on("click",t=>{this.hideMenu()})}showMenu(){this.menuDiv.atts({style:"width: 70%"})}hideMenu(){this.menuDiv.atts({style:"width: 0"})}}),y.db.ready().then(()=>{y.refresh(),console.log("ok")}),y.showModal=function(t,e){return y.modalContainer.showModal(t,e)},y.goto=function(t){},y.refresh=function(){let t={};this.db.getAll("target").then(e=>{t.targets=e,this.db.getAll("record").then(e=>{t.records=e,this.db.getAll("category").then(e=>{t.categories=e,this.emit("refresh",t)})})})},y.putTarget=function(t){this.db.putTarget(t).then(t=>{this.refresh()})}}();